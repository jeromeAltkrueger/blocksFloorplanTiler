name: Trigger auto deployment for blockstilingservice

# When this action will be executed
on:
  # Automatically trigger it when detected changes in repo
  push:
    branches: 
      [ main ]
    paths:
    - '**'
    - '.github/workflows/blockstilingservice-AutoDeployTrigger-b7f77713-4096-4e3c-abd2-8ef9bcb2e0c1.yml'

  # Allow manual trigger 
  workflow_dispatch:      

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions: 
      id-token: write #This is required for requesting the OIDC JWT Token
      contents: read #Required when GH token is used to authenticate with private repo

    steps:
      - name: Checkout to the branch
        uses: actions/checkout@v2

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.BLOCKSTILINGSERVICE_AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.BLOCKSTILINGSERVICE_AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.BLOCKSTILINGSERVICE_AZURE_SUBSCRIPTION_ID }}

      - name: Build and deploy to Azure Container Apps
        run: |
          # Ensure Container App has system-assigned managed identity
          az containerapp identity assign \
            --name blockstilingservice \
            --resource-group KompassExperimental \
            --system-assigned || true
          
          # Build container image in ACR
          IMAGE_TAG=$(date +%Y%m%d%H%M%S)
          az acr build \
            --registry ca285afb5d06acr \
            --image blockstilingservice:${IMAGE_TAG} \
            --image blockstilingservice:latest \
            --file Dockerfile \
            .
          
          # Update Container App with new image and environment variables
          az containerapp update \
            --name blockstilingservice \
            --resource-group KompassExperimental \
            --image ca285afb5d06acr.azurecr.io/blockstilingservice:${IMAGE_TAG} \
            --set-env-vars \
              AZURE_STORAGE_CONNECTION_STRING="DefaultEndpointsProtocol=https;AccountName=blocksplayground;AccountKey=kkEgPRG9ve1s/1mv/xNXdMwpd4Yp7tQVnweFnQvbWCK45khrlyJJnhLVKKZXB8BS/fzhRIPkYtEO+AStKbWzrw==;EndpointSuffix=core.windows.net" \
              TEST_STORAGE_ACCOUNT_NAME="blocksplayground" \
              PRODUCTION_STORAGE_CONNECTION_STRING="DefaultEndpointsProtocol=https;AccountName=productionstorageblocks;AccountKey=d0WDrWnXsj+g9K8onIBIMSB/kYIiC0sraJVxkDJiZdRuN60CE6ojMojUD8VIdEUOaA/4kDz3G3ge+AStM5ceEw==;EndpointSuffix=core.windows.net" \
              PRODUCTION_STORAGE_ACCOUNT_NAME="productionstorageblocks"


